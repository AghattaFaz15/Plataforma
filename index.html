<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>üé• Grava√ß√£o 360¬∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Biblioteca de QR Code corrigida -->
  <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>

  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #0b132b;
      color: white;
      margin: 0;
      padding: 0;
    }
    h2 {
      background: #091f36;
      padding: 10px;
      border-bottom: 2px solid gold;
      margin: 0;
    }
    video {
      width: 100%;
      border-bottom: 3px solid gold;
    }
    button {
      padding: 10px 20px;
      font-size: 18px;
      margin: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      color: white;
    }
    #startBtn { background: #1abc9c; }
    #stopBtn { background: #e74c3c; }
    #qrCode { margin-top: 20px; }
  </style>
</head>
<body>

  <h2>üé• Grava√ß√£o 360¬∞</h2>
  <video id="preview" autoplay playsinline></video>

  <div>
    <button id="startBtn">‚ñ∂Ô∏è Gravar</button>
    <button id="stopBtn" disabled>‚èπ Parar</button>
  </div>

  <div id="status"></div>
  <div id="qrCode"></div>

  <script>
    const video = document.getElementById('preview');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusDiv = document.getElementById('status');
    let mediaRecorder;
    let chunks = [];

    // Configura√ß√£o Cloudinary
    const cloudName = "dxobnhynf"; 
    const uploadPreset = "plataforma_360"; // Certifique-se que √© unsigned

    async function initCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
          audio: false
        });
        video.srcObject = stream;
        mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm;codecs=vp8" });

        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = uploadVideo;
      } catch (err) {
        alert("Erro ao acessar a c√¢mera: " + err.message);
      }
    }

    function startRecording() {
      chunks = [];
      mediaRecorder.start();
      startBtn.disabled = true;
      stopBtn.disabled = false;
      statusDiv.textContent = "üî¥ Gravando...";
    }

    function stopRecording() {
      mediaRecorder.stop();
      startBtn.disabled = false;
      stopBtn.disabled = true;
      statusDiv.textContent = "‚è≥ Enviando v√≠deo...";
    }

    async function uploadVideo() {
      const blob = new Blob(chunks, { type: "video/webm" });
      const formData = new FormData();
      formData.append("file", blob);
      formData.append("upload_preset", uploadPreset);

      try {
        const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/video/upload`, {
          method: "POST",
          body: formData
        });

        const data = await res.json();
        console.log("URL do v√≠deo:", data.secure_url);

        statusDiv.innerHTML = `‚úÖ V√≠deo enviado!<br><a href="${data.secure_url}" target="_blank" style="color: gold;">Abrir V√≠deo</a>`;

        // Gerar QR Code
        document.getElementById("qrCode").innerHTML = "";
        const qrCode = new QRCodeStyling({
          width: 200,
          height: 200,
          data: data.secure_url,
          dotsOptions: { color: "#FFD700", type: "rounded" },
          backgroundOptions: { color: "#0b132b" }
        });
        qrCode.append(document.getElementById("qrCode"));
      } catch (err) {
        statusDiv.textContent = "‚ùå Erro ao enviar v√≠deo: " + err.message;
      }
    }

    initCamera();
    startBtn.onclick = startRecording;
    stopBtn.onclick = stopRecording;
  </script>

</body>
</html>
