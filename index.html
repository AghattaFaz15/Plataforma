<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Grava√ß√£o + Zoom + Slow + QR</title>
<style>
body{margin:0;background:#000;color:#fff;font-family:Arial,sans-serif;text-align:center}
h1{color:#ffd700;margin:16px 0}
.wrap{width:100%;max-width:520px;margin:16px auto;padding:0 12px}
.frame{border:2px solid #ffd700;border-radius:12px;overflow:hidden}
video, canvas{width:100%;display:block;transform-origin:center center}
.row{margin:12px 0}
button{background:#ffd700;color:#000;border:0;border-radius:8px;padding:10px 14px;font-size:16px;cursor:pointer;margin:6px}
#qrcode{margin:16px auto}
.status{font-size:.9rem;margin:8px auto;opacity:.9}
</style>
</head>
<body>
<h1>üé• Grava√ß√£o + Zoom + Slow + QR</h1>
<div class="wrap">
  <div class="frame"><video id="live" autoplay muted playsinline></video></div>
  <div class="row">
    <button id="btnStart">‚ñ∂Ô∏è Gravar 10s</button>
  </div>
  <div class="status" id="status"></div>
  <h3>üìΩÔ∏è Playback</h3>
  <div class="frame"><video id="playback" controls></video></div>
  <div id="qrcode"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
const CLOUD_NAME = "dxobnhynf";
const UPLOAD_PRESET = "Plataforma_360";

const vLive = document.getElementById('live');
const vOut  = document.getElementById('playback');
const btnStart = document.getElementById('btnStart');
const statusEl = document.getElementById('status');
const qrBox    = document.getElementById('qrcode');

let stream, mediaRecorder, chunks = [];
let zoomTimer = null;
let rafZoomOut = null;

const sleep = ms => new Promise(r => setTimeout(r, ms));
const setStatus = msg => statusEl.textContent = msg ?? "";

async function startCamera(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:{exact:"environment"}}, audio:false});
  }catch(e){
    stream = await navigator.mediaDevices.getUserMedia({video:true, audio:false});
  }
  vLive.srcObject = stream;
}

function startLiveZoom(){
  let scale=1, dir=1;
  zoomTimer = setInterval(()=>{
    scale += dir*0.012;
    if(scale>=1.6) dir=-1;
    if(scale<=1) dir=1;
    vLive.style.transform = `scale(${scale})`;
  },50);
}

function stopLiveZoom(){
  if(zoomTimer){ clearInterval(zoomTimer); zoomTimer=null;}
  vLive.style.transform='scale(1)';
}

// Zoom no playback
function startPlaybackZoom(){
  cancelPlaybackZoom();
  let scale=1, dir=1;
  const step = ()=>{
    if(!vOut.paused){
      scale += dir*0.0009;
      if(scale>=1.6) dir=-1;
      if(scale<=1) dir=1;
      vOut.style.transform = `scale(${scale})`;
    }
    rafZoomOut = requestAnimationFrame(step);
  };
  rafZoomOut = requestAnimationFrame(step);
}

function cancelPlaybackZoom(){
  if(rafZoomOut){ cancelAnimationFrame(rafZoomOut); rafZoomOut=null;}
  vOut.style.transform='scale(1)';
}

// Slow alternado
function startAltSlow(video){
  let i=0;
  const pattern = [0.5,2,0.5,2]; // alterna velocidade
  const interval = 4000;
  const step = ()=>{
    if(video.paused) return;
    video.playbackRate = pattern[i%pattern.length];
    i++;
    setTimeout(step, interval);
  };
  step();
}

// Upload para Cloudinary
async function uploadToCloud(blob){
  const file = new File([blob],"video.webm",{type:'video/webm'});
  const fd = new FormData();
  fd.append("file",file);
  fd.append("upload_preset",UPLOAD_PRESET);
  const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/video/upload`, {method:"POST", body:fd});
  if(!res.ok) throw new Error("Upload falhou");
  return res.json();
}

// Gera QR
function makeQR(url){
  qrBox.innerHTML="";
  new QRCode(qrBox,{text:url,width:220,height:220,correctLevel:QRCode.CorrectLevel.H});
}

// Grava 10s
async function record10s(){
  chunks=[];
  mediaRecorder = new MediaRecorder(stream,{mimeType:'video/webm;codecs=vp8'});
  mediaRecorder.ondataavailable = e=>{ if(e.data.size) chunks.push(e.data); };

  return new Promise(async resolve=>{
    mediaRecorder.onstop = async ()=>{
      await sleep(50);
      const blob = new Blob(chunks,{type:'video/webm'});
      resolve(blob);
    };
    mediaRecorder.start(250);
    await sleep(10300);
    try{ mediaRecorder.requestData(); }catch(_){}
    mediaRecorder.stop();
  });
}

btnStart.addEventListener('click', async ()=>{
  btnStart.disabled=true;
  setStatus("üé¨ Gravando 10s‚Ä¶");
  startLiveZoom();

  const blob = await record10s();

  stopLiveZoom();
  try{ stream.getTracks().forEach(t=>t.stop()); }catch(_){}
  vLive.srcObject=null;

  // playback
  const localURL = URL.createObjectURL(blob);
  vOut.src = localURL;
  vOut.loop = true;
  await vOut.play().catch(()=>{});
  startAltSlow(vOut);
  startPlaybackZoom();

  setStatus("‚¨ÜÔ∏è Enviando para Cloud‚Ä¶");
  try{
    const data = await uploadToCloud(blob);
    if(data.secure_url){
      makeQR(data.secure_url);
      setStatus("‚úÖ Upload conclu√≠do. QR gerado.");
    }else{
      makeQR(localURL);
      setStatus("‚ö†Ô∏è Sem URL do Cloud, QR local gerado.");
    }
  }catch(err){
    console.error(err);
    makeQR(localURL);
    setStatus("‚ö†Ô∏è Upload falhou, QR local gerado.");
  }
});

startCamera();
</script>
</body>
</html>
