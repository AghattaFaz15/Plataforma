<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Grava√ß√£o + Zoom + Slow + QR</title>
<style>
  :root { --gold:#ffd700; }
  body{margin:0;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif;text-align:center}
  h1{color:var(--gold);margin:16px 0}
  .wrap{width:100%;max-width:520px;margin:16px auto;padding:0 12px}
  .frame{border:2px solid var(--gold);border-radius:12px;overflow:hidden}
  video{width:100%;display:block;transform-origin:center center}
  .row{margin:12px 0}
  button{background:var(--gold);color:#000;border:0;border-radius:8px;padding:10px 14px;font-size:16px;cursor:pointer;margin:6px}
  button[disabled]{opacity:.6;cursor:not-allowed}
  #qrcode{margin:16px auto}
  .hint{opacity:.8;font-size:.9rem;margin-top:6px}
  .status{font-size:.9rem;margin:8px auto;opacity:.9}
</style>
</head>
<body>
  <h1>üé• Gravar + Slow + Zoom + QR</h1>

  <div class="wrap">
    <div class="frame"><video id="live" autoplay muted playsinline></video></div>
    <div class="row">
      <button id="btnStart">‚ñ∂Ô∏è Gravar 10s</button>
      <button id="btnAlt" disabled>üîÅ Slow Alternado</button>
      <button id="btnExact" disabled>‚è±Ô∏è Slow 20s Exatos</button>
    </div>
    <div class="status" id="status"></div>

    <h3>üìΩÔ∏è Playback</h3>
    <div class="frame"><video id="playback" controls></video></div>
    <div class="hint">Pausou o player? o zoom pausa junto.</div>

    <div id="qrcode"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
  // ====== Config Cloudinary ======
  const CLOUD_NAME = "dxobnhynf";
  const UPLOAD_PRESET = "ml_default";

  // ====== DOM ======
  const vLive = document.getElementById('live');
  const vOut  = document.getElementById('playback');
  const btnStart = document.getElementById('btnStart');
  const btnAlt   = document.getElementById('btnAlt');
  const btnExact = document.getElementById('btnExact');
  const statusEl = document.getElementById('status');
  const qrBox    = document.getElementById('qrcode');

  // ====== Estado ======
  let stream, rec, chunks = [];
  let zoomTimerLive = null;
  let rafZoomOut = null;
  let altTimer = null;

  // ====== Helpers ======
  const setStatus = (msg) => statusEl.textContent = msg ?? "";
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  // Inicia c√¢mera traseira com fallback
  async function startCamera(){
    try{
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { exact: "environment" } }, audio: false
      });
    }catch(e){
      stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
    }
    vLive.srcObject = stream;
  }

  // Zoom org√¢nico no preview (grava√ß√£o)
  function startLiveZoom(){
    let s=1, dir=1;
    stopLiveZoom(); // garante √∫nico
    zoomTimerLive = setInterval(()=>{
      s += dir*0.012;               // zoom mais ‚Äúvivo‚Äù
      if(s>=1.8) dir=-1;
      if(s<=1.0) dir=1;
      vLive.style.transform = `scale(${s})`;
    }, 50);
  }
  function stopLiveZoom(){
    if(zoomTimerLive){ clearInterval(zoomTimerLive); zoomTimerLive = null; }
    vLive.style.transform = 'scale(1)';
  }

  // Zoom org√¢nico no playback (pausa = pausa zoom)
  function startOutZoom(){
    cancelOutZoom();
    let s=1, dir=1;
    const step = ()=>{
      if(!vOut.paused){
        s += dir*0.0009;
        if(s>=1.7) dir=-1;
        if(s<=1.0) dir=1;
        vOut.style.transform = `scale(${s})`;
      }
      rafZoomOut = requestAnimationFrame(step);
    };
    rafZoomOut = requestAnimationFrame(step);
  }
  function cancelOutZoom(){
    if(rafZoomOut){ cancelAnimationFrame(rafZoomOut); rafZoomOut = null; }
    vOut.style.transform = 'scale(1)';
  }

  // Slow alternado (efeito visual ‚âà 20s, n√£o exato)
  function startAltSlow(){
    stopAltSlow();
    // alterna 4s a 0.5x (estica) e 2s a 2x (comprime) em tempo de REPRODU√á√ÉO
    // isso d√° um efeito org√¢nico e prolonga bem, mas n√£o crava 20s.
    vOut.playbackRate = 0.5;
    altTimer = setInterval(()=>{
      vOut.playbackRate = (vOut.playbackRate === 0.5) ? 2.0 : 0.5;
    }, 4000); // troca a cada 4s de reprodu√ß√£o
  }
  function stopAltSlow(){
    if(altTimer){ clearInterval(altTimer); altTimer = null; }
  }

  // Slow 20s exatos (todo o clipe em 0.5x)
  function exact20s(){
    stopAltSlow();
    vOut.playbackRate = 0.5; // 10s de fonte => 20s de reprodu√ß√£o
  }

  // Gera QR
  function makeQR(url){
    qrBox.innerHTML = "";
    new QRCode(qrBox, { text:url, width:220, height:220, correctLevel: QRCode.CorrectLevel.H });
  }

  // Upload para Cloudinary
  async function uploadToCloud(blob){
    const file = new File([blob], "video.webm", { type:'video/webm' });
    const fd = new FormData();
    fd.append("file", file);
    fd.append("upload_preset", UPLOAD_PRESET);

    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/video/upload`, {
      method:"POST", body: fd
    });
    if(!res.ok) throw new Error("Upload falhou");
    return res.json();
  }

  // ====== Grava√ß√£o 10s ‚Äúcheios‚Äù (evita cair pra 9s) ======
  async function record10s(){
    chunks = [];
    rec = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp8' });

    rec.ondataavailable = (e)=>{ if(e.data && e.data.size) chunks.push(e.data); };
    const startedAt = performance.now();

    return new Promise(async (resolve)=>{
      rec.onstop = async ()=>{
        // pequena espera garante √∫ltimo peda√ßo em alguns browsers
        await sleep(50);
        const blob = new Blob(chunks, { type:'video/webm' });
        resolve({ blob, ms: performance.now() - startedAt });
      };

      // timeslice para for√ßar ‚Äúflush‚Äù recorrente de chunks
      rec.start(250); // coleta a cada 250ms

      // garante pelo menos 10.3s antes de parar (margem pra n√£o fechar em 9.x)
      await sleep(10300);
      // for√ßa √∫ltimo chunk antes de parar
      try{ rec.requestData(); }catch(_){}
      rec.stop();
    });
  }

  // ====== Fluxo principal ======
  btnStart.addEventListener('click', async ()=>{
    btnStart.disabled = true; setStatus("üé¨ Gravando 10s‚Ä¶");
    startLiveZoom();

    const result = await record10s();

    // encerra c√¢mera e preview
    stopLiveZoom();
    try { stream.getTracks().forEach(t=>t.stop()); } catch(_){}
    vLive.srcObject = null;

    // playback local imediato
    const localURL = URL.createObjectURL(result.blob);
    vOut.src = localURL;
    vOut.loop = true;
    await vOut.play().catch(()=>{});
    setStatus(`‚úÖ Gravado (~${(result.ms/1000).toFixed(1)}s). Enviando ao Cloud‚Ä¶`);

    // efeitos no playback
    startOutZoom();
    btnAlt.disabled = false;
    btnExact.disabled = false;
    exact20s(); // come√ßa em 20s exatos; voc√™ pode clicar "Alternar" depois

    // upload + QR
    try{
      const data = await uploadToCloud(result.blob);
      if(data && data.secure_url){
        makeQR(data.secure_url);
        setStatus("‚úÖ Upload conclu√≠do. QR gerado.");
      }else{
        setStatus("‚ö†Ô∏è Upload sem URL. Mostrando local.");
        makeQR(localURL);
      }
    }catch(err){
      setStatus("‚ö†Ô∏è Upload falhou. QR do v√≠deo local gerado.");
      makeQR(localURL);
      console.error(err);
    }
  });

  // Bot√µes de modo de slow
  btnAlt.addEventListener('click', ()=>{
    startAltSlow();
    setStatus("üîÅ Slow alternado ativo (dura√ß√£o visual ‚âà 20s).");
  });
  btnExact.addEventListener('click', ()=>{
    exact20s();
    setStatus("‚è±Ô∏è Slow 20s exatos (0.5x).");
  });

  // Pausar = pausar ‚Äúzoom playback‚Äù
  vOut.addEventListener('pause', ()=>{ /* o loop j√° respeita paused */ });
  vOut.addEventListener('play', ()=>{ /* nada, j√° est√° rodando */ });

  // start
  startCamera();
  </script>
</body>
</html>
