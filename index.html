<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grava√ß√£o com Zoom Org√¢nico + Slow + QR</title>
<style>
body { margin:0; background:#000; color:#fff; font-family:Arial,sans-serif; text-align:center; }
h1 { color:#ffd700; }
.video-wrapper { width:100%; max-width:520px; margin:20px auto; overflow:hidden; border:2px solid gold; border-radius:12px; }
video, canvas { width:100%; display:block; }
button { background:#ffd700; color:#000; border:none; border-radius:8px; padding:10px 14px; margin:6px; cursor:pointer; font-size:16px; }
#qrcode { margin:20px auto; }
.status { margin:10px auto; font-size:0.9rem; opacity:0.8; }
</style>
</head>
<body>
<h1>üé• Grava√ß√£o + Zoom Org√¢nico + Slow + QR</h1>

<div class="video-wrapper">
  <video id="preview" autoplay muted playsinline></video>
</div>
<button id="btnRecord">‚ñ∂Ô∏è Gravar 10s</button>

<h2>üìΩÔ∏è Playback</h2>
<div class="video-wrapper">
  <video id="playback" controls></video>
</div>
<div id="qrcode"></div>
<div class="status" id="status"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
const CLOUD_NAME = "dxobnhynf";
const UPLOAD_PRESET = "Plataforma_360";
const preview = document.getElementById("preview");
const playback = document.getElementById("playback");
const btnRecord = document.getElementById("btnRecord");
const qrBox = document.getElementById("qrcode");
const statusEl = document.getElementById("status");

let stream, chunks = [];

// Inicia c√¢mera traseira
async function startCamera() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } }, audio: false });
  } catch(e) {
    stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
  }
  preview.srcObject = stream;
}
startCamera();

// Grava com zoom org√¢nico em canvas
async function recordZoomedVideo() {
  const videoTrack = stream.getVideoTracks()[0];
  const settings = videoTrack.getSettings();
  const canvas = document.createElement("canvas");
  canvas.width = settings.width || 640;
  canvas.height = settings.height || 480;
  const ctx = canvas.getContext("2d");

  let scale = 1, dir = 1;

  const recorderStream = canvas.captureStream(30);
  const recorder = new MediaRecorder(recorderStream, { mimeType: "video/webm; codecs=vp8" });
  let localChunks = [];
  recorder.ondataavailable = e => { if(e.data && e.data.size) localChunks.push(e.data); };
  recorder.start(100);

  return new Promise(resolve=>{
    let startTime = performance.now();
    function drawFrame(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      scale += dir*0.0025;
      if(scale>1.6) dir=-1;
      if(scale<1.0) dir=1;
      ctx.save();
      ctx.translate(canvas.width/2, canvas.height/2);
      ctx.scale(scale, scale);
      ctx.translate(-canvas.width/2, -canvas.height/2);
      ctx.drawImage(preview, 0,0,canvas.width, canvas.height);
      ctx.restore();
      if(performance.now() - startTime < 10000) {
        requestAnimationFrame(drawFrame);
      } else {
        recorder.stop();
      }
    }
    drawFrame();

    recorder.onstop = ()=>{
      const blob = new Blob(localChunks, {type:"video/webm"});
      resolve(blob);
    };
  });
}

// Alterna velocidade (slow/fast)
function applyPlaybackPattern(video){
  let t=0;
  const duration = video.duration;
  video.playbackRate = 1;
  function step(){
    if(video.paused) return;
    t += 0.04;
    // alterna: 2s r√°pido, 3s lento = efeito 10s -> 20s
    if((t%5)<2) video.playbackRate=2; else video.playbackRate=0.5;
    requestAnimationFrame(step);
  }
  step();
}

// Upload Cloudinary
async function uploadCloud(blob){
  const fd = new FormData();
  fd.append("file", new File([blob], "video.webm", {type:"video/webm"}));
  fd.append("upload_preset", UPLOAD_PRESET);
  const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/video/upload`, {method:"POST", body:fd});
  if(!res.ok) throw new Error("Falha upload");
  return res.json();
}

// QR Code
function makeQR(url){
  qrBox.innerHTML="";
  new QRCode(qrBox, { text:url, width:220, height:220, correctLevel:QRCode.CorrectLevel.H });
}

// Bot√£o
btnRecord.onclick = async ()=>{
  btnRecord.disabled=true;
  statusEl.textContent="üé¨ Gravando 10s com zoom org√¢nico‚Ä¶";
  const blob = await recordZoomedVideo();
  statusEl.textContent="‚úÖ Grava√ß√£o completa. Enviando ao Cloud‚Ä¶";

  playback.src = URL.createObjectURL(blob);
  playback.loop = true;
  playback.play();
  applyPlaybackPattern(playback);

  try{
    const data = await uploadCloud(blob);
    makeQR(data.secure_url);
    statusEl.textContent="‚úÖ Upload conclu√≠do. QR Code gerado!";
  }catch(e){
    makeQR(playback.src);
    statusEl.textContent="‚ö†Ô∏è Falha upload. QR Code do v√≠deo local gerado.";
    console.error(e);
  }
};
</script>
</body>
</html>
