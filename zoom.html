<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Zoom Orgânico</title>
<style>
body,html{margin:0;padding:0;overflow:hidden;background:#000;}
video{display:none;}
canvas{width:100%;height:100%;}
</style>
</head>
<body>

<video id="mainVideo" autoplay playsinline></video>
<canvas id="videoCanvas"></canvas>

<script>
const mainVideo = document.getElementById('mainVideo');
const canvas = document.getElementById('videoCanvas');
const ctx = canvas.getContext('2d');

let mediaRecorder, chunks=[], recording=false, animFrame;
const totalDuration = 10000; // 10s base

async function initCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
  mainVideo.srcObject = stream;
  await mainVideo.play();
  canvas.width = mainVideo.videoWidth||640;
  canvas.height = mainVideo.videoHeight||480;
}

// Zoom orgânico
let zoomScale = 1, zoomDir=0.008;
function getZoom(){ zoomScale += zoomDir; if(zoomScale>2||zoomScale<1) zoomDir*=-1; return zoomScale; }

function drawFrame(){
  if(!recording) return;
  const scale = getZoom();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const w = canvas.width*scale, h = canvas.height*scale;
  const dx = (canvas.width-w)/2, dy=(canvas.height-h)/2;
  ctx.drawImage(mainVideo,dx,dy,w,h);
  animFrame = requestAnimationFrame(drawFrame);
}

function startRecording(){
  chunks=[];
  recording=true;
  drawFrame();
  const canvasStream = canvas.captureStream(30);
  mediaRecorder = new MediaRecorder(canvasStream,{mimeType:'video/webm;codecs=vp8'});
  mediaRecorder.ondataavailable=e=>{ if(e.data.size) chunks.push(e.data); };
  mediaRecorder.start();
  setTimeout(stopRecording,totalDuration);
}

function stopRecording(){
  recording=false;
  cancelAnimationFrame(animFrame);
  mediaRecorder.stop();
  mediaRecorder.onstop=()=>{
    const blob = new Blob(chunks,{type:'video/webm'});
    window.parent.postMessage({ videoBlob: blob }, '*');
  };
}

// Recebe start do index
window.addEventListener('message', e=>{
  if(e.data.action==='start'){
    initCamera().then(startRecording);
  }
});
</script>

</body>
</html>
