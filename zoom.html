<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>ðŸŽ¬ Zoom + Slow Motion Profissional</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root { --azul:#0b132b; --dourado:#d4af37; }
body { font-family: system-ui, sans-serif; text-align:center; background:var(--azul); color:#fff; margin:0; padding:30px; }
h2 { margin:20px 0; }
video { display:none; }
canvas { width:100%; max-height:55vh; object-fit:cover; border:3px solid var(--dourado); margin-bottom:15px; transform-origin:center center; }
</style>
</head>
<body>

<h2>ðŸŽ¬ Zoom + Slow Motion Profissional</h2>
<video id="mainVideo" autoplay muted playsinline></video>
<canvas id="videoCanvas"></canvas>

<script>
const mainVideo = document.getElementById('mainVideo');
const canvas = document.getElementById('videoCanvas');
const ctx = canvas.getContext('2d');

let stream;
let recording = false;
let frameHistory = [];
let currentFrameIndex = 0;

const baseDuration = 10000; // 10s reais
const slowFactor = 9.0; // 2x slow, vÃ­deo final ~20s

async function initCamera(){
  stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
  mainVideo.srcObject = stream;
  await mainVideo.play();
  canvas.width = mainVideo.videoWidth || 640;
  canvas.height = mainVideo.videoHeight || 480;
}

// Zoom orgÃ¢nico
let zoomScale = 1;
let zoomDirection = 0.008;
function getZoom(){ 
  zoomScale += zoomDirection; 
  if(zoomScale>2 || zoomScale<1) zoomDirection*=-1;
  return zoomScale;
}

// Captura frames reais
function captureFrame(){
  const frame = document.createElement('canvas');
  frame.width = canvas.width;
  frame.height = canvas.height;
  frame.getContext('2d').drawImage(mainVideo, 0, 0, canvas.width, canvas.height);
  frameHistory.push(frame);
}

// Desenha com zoom + slow motion
function drawFrame(){
  if(!recording) return;
  if(currentFrameIndex >= frameHistory.length) currentFrameIndex = frameHistory.length -1;

  const scale = getZoom();
  ctx.save();
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const frame = frameHistory[Math.floor(currentFrameIndex)];
  const w = canvas.width * scale;
  const h = canvas.height * scale;
  const dx = (canvas.width - w)/2;
  const dy = (canvas.height - h)/2;
  ctx.drawImage(frame, dx, dy, w, h);
  ctx.restore();

  currentFrameIndex += 1/slowFactor;
  requestAnimationFrame(drawFrame);
}

// Inicia gravaÃ§Ã£o
async function startRecording(){
  frameHistory = [];
  currentFrameIndex = 0;
  recording = true;

  // captura frames durante baseDuration (10s)
  const captureInterval = setInterval(captureFrame, 33);
  setTimeout(()=>{
    clearInterval(captureInterval);

    // grava via canvas
    const streamCanvas = canvas.captureStream(30);
    const mediaRecorder = new MediaRecorder(streamCanvas, { mimeType:'video/webm;codecs=vp8' });
    let chunks = [];
    mediaRecorder.ondataavailable = e=>{ if(e.data && e.data.size) chunks.push(e.data); };
    mediaRecorder.onstop = ()=>{
      const blob = new Blob(chunks,{type:'video/webm'});
      // envia para o index
      window.parent.postMessage({ videoBlob: blob }, '*');
    };
    mediaRecorder.start();
    drawFrame();

    // define duraÃ§Ã£o final do vÃ­deo (slow)
    setTimeout(()=>{
      recording = false;
      mediaRecorder.stop();
    }, baseDuration*slowFactor);
  }, baseDuration);
}

// Inicia cÃ¢mera e gravaÃ§Ã£o automaticamente
initCamera().then(startRecording);
</script>
</body>
</html>
