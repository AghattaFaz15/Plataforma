<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>üé• Zoom Progressivo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
:root { --azul:#0b132b; --dourado:#d4af37; }
body { font-family: system-ui; text-align:center; background:var(--azul); color:#fff; margin:0; }
h2 { background: #091f36; padding:12px; border-bottom:2px solid var(--dourado); margin:0; }
video { width:100%; max-height:55vh; object-fit:cover; border-bottom:3px solid var(--dourado); }
canvas { display:none; }
.bar { display:flex; gap:12px; justify-content:center; padding:14px 10px; border-top:2px solid var(--dourado); }
button { padding:12px 22px; font-size:18px; border:none; border-radius:10px; cursor:pointer; color:#fff; box-shadow:0 6px 16px rgba(0,0,0,.25); }
#startBtn { background:#1abc9c; }
#stopBtn { background:#e74c3c; }
#status { min-height:48px; margin:8px 0; font-weight:600; }
#qrCode { margin:14px auto 30px; width:200px; height:200px; display:grid; place-items:center; background:#0b132b; border:2px solid var(--dourado); border-radius:12px; }
a.link { color:var(--dourado); text-decoration:underline; word-break:break-all; }
</style>
</head>
<body>
<h2>üé• Zoom Progressivo</h2>
<video id="preview" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<div class="bar">
  <button id="startBtn">‚ñ∂Ô∏è Gravar</button>
  <button id="stopBtn" disabled>‚èπ Parar</button>
</div>

<div id="status"></div>
<div id="qrCode"></div>

<script>
const video = document.getElementById('preview');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const statusDiv = document.getElementById('status');
const qrBox = document.getElementById('qrCode');
let mediaRecorder, chunks = [], captureInterval;

const cloudName = 'dxobnhynf';
const uploadPreset = 'plataforma_360';

async function initCamera(){
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio:false });
    video.srcObject = stream;
  } catch(err){ alert('Erro ao acessar a c√¢mera: '+err.message); }
}

function startRecording(){
  chunks=[];
  startBtn.disabled=true;
  stopBtn.disabled=false;
  statusDiv.textContent='üî¥ Gravando...';
  qrBox.innerHTML='';

  let zoom=1, zoomDir=1;
  captureInterval = setInterval(()=>{
    const w=video.videoWidth||640;
    const h=video.videoHeight||480;
    canvas.width=w; canvas.height=h;
    zoom+=0.002*zoomDir;
    if(zoom>1.2||zoom<1) zoomDir*=-1;
    const sw=w/zoom, sh=h/zoom;
    ctx.drawImage(video,(w-sw)/2,(h-sh)/2,sw,sh,0,0,w,h);
  },33);

  const stream=canvas.captureStream(30);
  mediaRecorder = new MediaRecorder(stream,{ mimeType:'video/webm;codecs=vp8' });
  mediaRecorder.ondataavailable=e=>{ if(e.data && e.data.size) chunks.push(e.data); };
  mediaRecorder.onstop=uploadVideo;
  mediaRecorder.start();
}

function stopRecording(){
  clearInterval(captureInterval);
  mediaRecorder.stop();
  startBtn.disabled=false;
  stopBtn.disabled=true;
  statusDiv.textContent='‚è≥ Enviando v√≠deo...';
}

function makeQR(url){
  qrBox.innerHTML='';
  new QRCode(qrBox,{text:url,width:200,height:200,correctLevel:QRCode.CorrectLevel.H});
}

async function uploadVideo(){
  const blob=new Blob(chunks,{type:'video/webm'});
  const formData=new FormData();
  formData.append('file',blob);
  formData.append('upload_preset',uploadPreset);

  try{
    const res=await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/video/upload`,{method:'POST',body:formData});
    const data=await res.json();
    if(!res.ok||data.error) throw new Error(data?.error?.message||('HTTP '+res.status));
    const url=data.secure_url;
    statusDiv.innerHTML=`‚úÖ V√≠deo enviado!<br><a class="link" href="${url}" target="_blank">Abrir v√≠deo</a>`;
    makeQR(url);
  } catch(err){ statusDiv.textContent='‚ùå Erro ao enviar v√≠deo: '+err.message; }
}

initCamera();
startBtn.onclick=startRecording;
stopBtn.onclick=stopRecording;
</script>
</body>
</html>
