<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>游꿟 Zoom + Slow/Speed Org칙nico</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root { --azul:#0b132b; --dourado:#d4af37; }
body { font-family: system-ui, sans-serif; text-align:center; background:var(--azul); color:#fff; margin:0; padding:30px; }
h2 { margin:20px 0; }
video { width:100%; max-height:55vh; object-fit:cover; border:3px solid var(--dourado); margin-bottom:15px; transform-origin:center center; }
canvas { display:none; }
</style>
</head>
<body>

<h2>游꿟 Zoom + Slow/Speed Org칙nico</h2>

<video id="mainVideo" autoplay muted playsinline></video>
<canvas id="videoCanvas"></canvas>

<script>
const mainVideo = document.getElementById('mainVideo');
const canvas = document.getElementById('videoCanvas');
const ctx = canvas.getContext('2d');

let mediaRecorder, chunks = [];
let stream;
let recording = false;
let animFrame;
const captureDuration = 10000; // 10 segundos "reais"
const zoomMax = 2;
const zoomMin = 1;

// --- Inicializa c칙mera ---
async function initCamera(){
  stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:true });
  mainVideo.srcObject = stream;
  await mainVideo.play();
  canvas.width = mainVideo.videoWidth || 640;
  canvas.height = mainVideo.videoHeight || 480;
}

// --- Zoom org칙nico ---
let zoomScale = 1;
let zoomDirection = 0.008;
function getZoom(){ 
  zoomScale += zoomDirection; 
  if(zoomScale > zoomMax || zoomScale < zoomMin) zoomDirection *= -1;
  return zoomScale;
}

// --- Slow/Speed org칙nico percept칤vel ---
let lastFrameTime = 0;
let lastFrameImage = null;
function getSlowMultiplier(){
  // alterna dramaticamente entre 0.1x (super lento) e 3x (super r치pido)
  return 0.1 + Math.random()*2.9;
}

// --- Desenha no canvas com slow/fast ---
function drawFrame(){
  if(!recording) return;

  const now = Date.now();
  const slowMult = getSlowMultiplier();
  
  if(!lastFrameTime || now - lastFrameTime >= (33 / slowMult)){
    lastFrameTime = now;

    const scale = getZoom();
    ctx.save();
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const w = canvas.width * scale;
    const h = canvas.height * scale;
    const dx = (canvas.width - w)/2;
    const dy = (canvas.height - h)/2;
    ctx.drawImage(mainVideo, dx, dy, w, h);
    ctx.restore();

    lastFrameImage = ctx.getImageData(0,0,canvas.width,canvas.height);
  } else if(lastFrameImage){
    // mant칠m frame anterior para efeito lento
    ctx.putImageData(lastFrameImage, 0, 0);
  }

  animFrame = requestAnimationFrame(drawFrame);
}

// --- Inicia grava칞칚o ---
function startRecording(){
  chunks = [];
  recording = true;
  lastFrameTime = 0;

  const canvasStream = canvas.captureStream(30);
  mediaRecorder = new MediaRecorder(canvasStream, { mimeType:'video/webm;codecs=vp8' });
  mediaRecorder.ondataavailable = e=>{ if(e.data && e.data.size) chunks.push(e.data); };
  mediaRecorder.start();

  drawFrame();

  // para grava칞칚o ap칩s 10 segundos "reais"
  setTimeout(stopRecording, captureDuration);
}

// --- Para grava칞칚o ---
function stopRecording(){
  recording = false;
  cancelAnimationFrame(animFrame);
  mediaRecorder.stop();

  mediaRecorder.onstop = ()=>{
    const blob = new Blob(chunks,{type:'video/webm'});
    // envia para o index para gerar QR Code
    window.parent.postMessage({ videoBlob: blob }, '*');
  };
}

// --- In칤cio ---
initCamera();
</script>
</body>
</html>
