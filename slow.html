<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Slow Motion Org√¢nico</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root { --azul:#0b132b; --dourado:#d4af37; }
body { font-family: system-ui, sans-serif; text-align:center; background:var(--azul); color:#fff; margin:0; padding:30px; }
h2 { margin:20px 0; }
button { padding:12px 22px; font-size:18px; border:none; border-radius:10px; cursor:pointer; color:#fff; background:var(--dourado); margin:10px; box-shadow:0 6px 16px rgba(0,0,0,.25);}
video { width:100%; max-height:55vh; object-fit:cover; border:3px solid var(--dourado); margin-bottom:15px; }
#status { min-height:48px; margin:12px 0; font-weight:600; }
</style>
</head>
<body>
<h2>üé¨ Slow Motion Org√¢nico</h2>
<button id="startSlow">‚ñ∂Ô∏è Iniciar Slow</button>
<video id="slowVideo" autoplay muted playsinline></video>
<canvas id="slowCanvas" style="display:none;"></canvas>
<div id="status">‚è≥ Aguardando in√≠cio...</div>

<script>
const startSlowBtn = document.getElementById('startSlow');
const slowVideo = document.getElementById('slowVideo');
const slowCanvas = document.getElementById('slowCanvas');
const ctx = slowCanvas.getContext('2d');
const statusDiv = document.getElementById('status');

let streamSlow;
let animSlow;
let mediaRecorder, chunks = [];
let recording = false;

// --- Inicializa c√¢mera ---
async function initSlow(){
  streamSlow = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
  slowVideo.srcObject = streamSlow;
  slowVideo.play();
  slowCanvas.width = slowVideo.videoWidth || 640;
  slowCanvas.height = slowVideo.videoHeight || 480;
  recording = true;
  drawSlowFrame();
  startRecording();
  statusDiv.textContent = 'üî¥ Gravando Slow Motion...';
}

// --- Varia velocidade org√¢nica ---
function getSlowFactor(){
  return 0.1 + Math.random() * 2.0; // 0.1x a 2x
}

// --- Desenha frames no canvas ---
function drawSlowFrame(){
  if(!recording) return;
  ctx.clearRect(0,0,slowCanvas.width,slowCanvas.height);
  ctx.drawImage(slowVideo,0,0,slowCanvas.width,slowCanvas.height);
  animSlow = setTimeout(()=>requestAnimationFrame(drawSlowFrame),33/getSlowFactor());
}

// --- Grava√ß√£o ---
function startRecording(){
  const stream = slowCanvas.captureStream(30);
  mediaRecorder = new MediaRecorder(stream, {mimeType:'video/webm;codecs=vp8'});
  mediaRecorder.ondataavailable = e=>{ if(e.data && e.data.size) chunks.push(e.data); };
  mediaRecorder.onstop = uploadVideo;
  mediaRecorder.start();
  setTimeout(stopRecording,10000);
}

function stopRecording(){
  recording = false;
  clearTimeout(animSlow);
  mediaRecorder.stop();
  statusDiv.textContent = '‚è≥ Grava√ß√£o finalizada!';
}

// --- Upload para Cloudinary ---
async function uploadVideo(){
  const blob = new Blob(chunks,{type:'video/webm'});
  const formData = new FormData();
  formData.append('file',blob);
  formData.append('upload_preset','plataforma_360');

  try{
    const res = await fetch('https://api.cloudinary.com/v1_1/dxobnhynf/video/upload',{method:'POST',body:formData});
    const data = await res.json();
    if(!res.ok||data.error) throw new Error(data?.error?.message||('HTTP '+res.status));
    const url = data.secure_url;
    statusDiv.innerHTML=`‚úÖ V√≠deo enviado!<br><a href="${url}" target="_blank">Abrir v√≠deo</a>`;
  }catch(err){statusDiv.textContent='‚ùå Erro: '+err.message;}
}

startSlowBtn.onclick = async ()=>{
  if(!streamSlow) await initSlow();
};
</script>
</body>
</html>
