<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>üé• Slow Motion Profissional</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root { --azul:#0b132b; --dourado:#d4af37; }
body { font-family: system-ui, sans-serif; text-align:center; background:var(--azul); color:#fff; margin:0; padding:30px; }
h2 { margin:20px 0; }
video { width:100%; max-height:55vh; object-fit:cover; border:3px solid var(--dourado); margin-bottom:15px; }
canvas { display:none; }
button { padding:12px 22px; font-size:18px; border:none; border-radius:10px; cursor:pointer; color:#fff; background:var(--dourado); margin:10px; box-shadow:0 6px 16px rgba(0,0,0,.25);}
</style>
</head>
<body>

<h2>üé• Slow Motion Profissional</h2>
<button id="startBtn">‚ñ∂Ô∏è Gravar Slow</button>

<video id="preview" autoplay muted playsinline></video>
<canvas id="canvas"></canvas>

<script>
const startBtn = document.getElementById('startBtn');
const preview = document.getElementById('preview');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let mediaRecorder, chunks = [];
let stream;
let frames = [];
const duration = 10000; // grava 10 segundos reais
const slowMultiplier = 2; // 2x slow (final ~20s)

async function initCamera(){
  stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
  preview.srcObject = stream;
  await preview.play();
  canvas.width = preview.videoWidth || 640;
  canvas.height = preview.videoHeight || 480;
}

function captureFrame(){
  ctx.drawImage(preview, 0, 0, canvas.width, canvas.height);
  frames.push(ctx.getImageData(0,0,canvas.width,canvas.height));
}

function playFramesSlow(){
  return new Promise(resolve=>{
    let i = 0;
    function drawNext(){
      if(i >= frames.length){
        resolve();
        return;
      }
      // desenha cada frame slowMultiplier vezes
      let repeat = 0;
      function repeatFrame(){
        if(repeat >= slowMultiplier){
          i++;
          requestAnimationFrame(drawNext);
          return;
        }
        ctx.putImageData(frames[i], 0, 0);
        repeat++;
        requestAnimationFrame(repeatFrame);
      }
      repeatFrame();
    }
    drawNext();
  });
}

async function startRecording(){
  chunks = [];
  frames = [];
  startBtn.disabled = true;

  const canvasStream = canvas.captureStream(30);
  mediaRecorder = new MediaRecorder(canvasStream, { mimeType:'video/webm;codecs=vp8' });
  mediaRecorder.ondataavailable = e=>{ if(e.data && e.data.size) chunks.push(e.data); };
  mediaRecorder.start();

  const startTime = Date.now();
  function captureLoop(){
    if(Date.now() - startTime < duration){
      captureFrame();
      requestAnimationFrame(captureLoop);
    } else {
      // grava slow
      playFramesSlow().then(()=>{
        mediaRecorder.stop();
      });
    }
  }
  captureLoop();
}

// --- envia para o index ---
mediaRecorder?.onstop = ()=>{
  const blob = new Blob(chunks,{type:'video/webm'});
  window.parent.postMessage({ videoBlob: blob }, '*');
};

startBtn.onclick = async ()=>{
  if(!stream) await initCamera();
  startRecording();
};
</script>
</body>
</html>
