<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Slow Orgânico</title>
<style>
body,html{margin:0;padding:0;overflow:hidden;background:#000;}
video{display:none;}
canvas{width:100%;height:100%;}
</style>
</head>
<body>

<video id="mainVideo" autoplay playsinline></video>
<canvas id="videoCanvas"></canvas>

<script>
const mainVideo = document.getElementById('mainVideo');
const canvas = document.getElementById('videoCanvas');
const ctx = canvas.getContext('2d');

let mediaRecorder, chunks=[], recording=false, animFrame;
const totalDuration = 10000; // 10s base

async function initCamera(){
  const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'},audio:false});
  mainVideo.srcObject = stream;
  await mainVideo.play();
  canvas.width = mainVideo.videoWidth||640;
  canvas.height = mainVideo.videoHeight||480;
}

// Slow/Speed orgânico perceptível
let lastFrame;
function getSlowFactor(){ return 0.1 + Math.random()*6.0; }

function drawFrame(){
  if(!recording) return;
  const slowFactor = getSlowFactor();
  if(!lastFrame || Math.random()<slowFactor) lastFrame=mainVideo;

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(lastFrame,0,0,canvas.width,canvas.height);

  animFrame = setTimeout(drawFrame,33);
}

function startRecording(){
  chunks=[];
  recording=true;
  drawFrame();
  const canvasStream = canvas.captureStream(30);
  mediaRecorder = new MediaRecorder(canvasStream,{mimeType:'video/webm;codecs=vp8'});
  mediaRecorder.ondataavailable=e=>{ if(e.data.size) chunks.push(e.data); };
  mediaRecorder.start();
  setTimeout(stopRecording,totalDuration);
}

function stopRecording(){
  recording=false;
  clearTimeout(animFrame);
  mediaRecorder.stop();
  mediaRecorder.onstop=()=>{
    const blob = new Blob(chunks,{type:'video/webm'});
    window.parent.postMessage({ videoBlob: blob }, '*');
  };
}

// Recebe start do index
window.addEventListener('message', e=>{
  if(e.data.action==='start'){
    initCamera().then(startRecording);
  }
});
</script>

</body>
</html>
