<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>üé• Slow Motion Org√¢nico</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
:root { --azul:#0b132b; --dourado:#d4af37; }
body { font-family: system-ui; text-align:center; background:var(--azul); color:#fff; margin:0; }
h2 { background: #091f36; padding:12px; border-bottom:2px solid var(--dourado); margin:0; }
video { width:100%; max-height:55vh; object-fit:cover; border-bottom:3px solid var(--dourado); }
canvas { display:none; }
#status { min-height:48px; margin:12px 0; font-weight:600; }
#qrCode { margin:14px auto 30px; width:200px; height:200px; display:grid; place-items:center; background:#0b132b; border:2px solid var(--dourado); border-radius:12px; }
a.link { color:var(--dourado); text-decoration:underline; word-break:break-all; }
</style>
</head>
<body>
<h2>üé• Slow Motion Org√¢nico</h2>
<video id="preview" autoplay playsinline muted></video>
<canvas id="canvas"></canvas>

<div id="status">‚è≥ Inicializando...</div>
<div id="qrCode"></div>

<script>
const video = document.getElementById('preview');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const statusDiv = document.getElementById('status');
const qrBox = document.getElementById('qrCode');

const cloudName = 'dxobnhynf';
const uploadPreset = 'plataforma_360';

let mediaRecorder, chunks = [];
let lastTime = Date.now();

// 1Ô∏è‚É£ Inicializa c√¢mera
async function initCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
    video.srcObject = stream;
    video.play();

    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 480;

    startRecording();
    fluctuateSpeed();
    drawFrame();
  } catch (err) {
    alert('Erro ao acessar a c√¢mera: ' + err.message);
  }
}

// 2Ô∏è‚É£ Varia velocidade do v√≠deo organicamente
function fluctuateSpeed() {
  setInterval(() => {
    let rate = 0.3 + Math.random() * 1.2; // 0.3 a 1.5x
    video.playbackRate = rate;
  }, 100);
}

// 3Ô∏è‚É£ Desenha frames no canvas (grava√ß√£o)
function drawFrame() {
  const now = Date.now();
  const delta = now - lastTime;
  const speedFactor = 0.5 + Math.random(); // varia√ß√£o org√¢nica
  if (delta > 33 / speedFactor) {
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    lastTime = now;
  }
  requestAnimationFrame(drawFrame);
}

// 4Ô∏è‚É£ Inicia grava√ß√£o autom√°tica
function startRecording() {
  const stream = canvas.captureStream(30);
  mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp8' });

  mediaRecorder.ondataavailable = e => { if (e.data && e.data.size) chunks.push(e.data); };
  mediaRecorder.onstop = uploadVideo;

  mediaRecorder.start();
  statusDiv.textContent = 'üî¥ Gravando Slow Motion Org√¢nico...';

  // grava por 10 segundos e depois envia
  setTimeout(() => {
    mediaRecorder.stop();
    statusDiv.textContent = '‚è≥ Enviando v√≠deo...';
  }, 10000); // tempo total de grava√ß√£o
}

// 5Ô∏è‚É£ Envia para Cloudinary e gera QR
async function uploadVideo() {
  const blob = new Blob(chunks, { type: 'video/webm' });
  const formData = new FormData();
  formData.append('file', blob);
  formData.append('upload_preset', uploadPreset);

  try {
    const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/video/upload`, { method: 'POST', body: formData });
    const data = await res.json();
    if (!res.ok || data.error) throw new Error(data?.error?.message || ('HTTP ' + res.status));
    const url = data.secure_url;
    statusDiv.innerHTML = `‚úÖ V√≠deo enviado!<br><a class="link" href="${url}" target="_blank">Abrir v√≠deo</a>`;
    makeQR(url);
  } catch (err) {
    statusDiv.textContent = '‚ùå Erro ao enviar v√≠deo: ' + err.message;
  }
}

// 6Ô∏è‚É£ Cria QR Code
function makeQR(url) {
  qrBox.innerHTML = '';
  new QRCode(qrBox, { text: url, width: 200, height: 200, correctLevel: QRCode.CorrectLevel.H });
}

initCamera();
</script>
</body>
</html>
