<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Slow Motion Profissional</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { margin:0; padding:0; }
video { display:none; }
canvas { display:none; }
</style>
</head>
<body>

<video id="cameraVideo" autoplay playsinline></video>
<canvas id="videoCanvas"></canvas>

<script>
const video = document.getElementById('cameraVideo');
const canvas = document.getElementById('videoCanvas');
const ctx = canvas.getContext('2d');

let stream, mediaRecorder, chunks = [];
let recording = false;
let animFrame;

const baseDuration = 10000; // 10s de gravação real
const slowMultiplier = 2.0; // slow vai prolongar para ~20s

// --- inicializa câmera ---
async function initCamera(){
  stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'environment' }, audio:false });
  video.srcObject = stream;
  await video.play();
  canvas.width = video.videoWidth || 640;
  canvas.height = video.videoHeight || 480;
}

// --- slow motion profissional ---
let zoomScale = 1;
let zoomDir = 0.008;
let lastFrame;

function getZoom(){
  zoomScale += zoomDir;
  if(zoomScale>2 || zoomScale<1) zoomDir*=-1;
  return zoomScale;
}

function getSlowFactor(){
  return 0.3 + Math.random()*5.7; // 0.3x → 6.0x
}

function drawFrame(){
  if(!recording) return;

  const scale = getZoom();
  const slowFactor = getSlowFactor();

  if(!lastFrame || Math.random() < slowFactor){
    lastFrame = video;
  }

  ctx.save();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const w = canvas.width * scale;
  const h = canvas.height * scale;
  const dx = (canvas.width - w)/2;
  const dy = (canvas.height - h)/2;
  ctx.drawImage(lastFrame, dx, dy, w, h);
  ctx.restore();

  animFrame = setTimeout(drawFrame, 33 / slowFactor);
}

// --- gravação ---
async function startRecording(){
  chunks = [];
  recording = true;

  const canvasStream = canvas.captureStream(30);
  mediaRecorder = new MediaRecorder(canvasStream, { mimeType:'video/webm;codecs=vp8' });
  mediaRecorder.ondataavailable = e=>{ if(e.data && e.data.size) chunks.push(e.data); };
  mediaRecorder.start();

  drawFrame();

  // grava 10s, mas slow prolonga
  setTimeout(stopRecording, baseDuration*slowMultiplier);
}

function stopRecording(){
  recording = false;
  clearTimeout(animFrame);
  mediaRecorder.stop();

  mediaRecorder.onstop = ()=>{
    const blob = new Blob(chunks,{type:'video/webm'});
    // envia pro index
    window.parent.postMessage({ videoBlob: blob }, '*');
  };
}

// --- inicia ---
initCamera().then(()=>startRecording());
</script>

</body>
</html>
