<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Slow Motion Profissional</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root { --azul:#0b132b; --dourado:#d4af37; }
body { font-family: system-ui, sans-serif; text-align:center; background:var(--azul); color:#fff; margin:0; padding:30px; }
h2 { margin:20px 0; }
button { padding:12px 22px; font-size:18px; border:none; border-radius:10px; cursor:pointer; color:#fff; background:var(--dourado); margin:10px; box-shadow:0 6px 16px rgba(0,0,0,.25);}
video { width:100%; max-height:55vh; object-fit:cover; border:3px solid var(--dourado); margin-bottom:15px; }
canvas { display:none; }
#status { min-height:48px; margin:12px 0; font-weight:600; }
</style>
</head>
<body>

<h2>üé¨ Slow Motion Profissional</h2>
<button id="startBtn">‚ñ∂Ô∏è Gravar 10s</button>

<video id="previewVideo" autoplay muted playsinline></video>
<canvas id="captureCanvas"></canvas>

<div id="status">‚è≥ Aguardando...</div>

<script>
const startBtn = document.getElementById('startBtn');
const previewVideo = document.getElementById('previewVideo');
const canvas = document.getElementById('captureCanvas');
const ctx = canvas.getContext('2d');
const statusDiv = document.getElementById('status');

let stream;
let frames = [];
let recording = false;

// --- Inicializa c√¢mera ---
async function initCamera(){
  stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
  previewVideo.srcObject = stream;
  await previewVideo.play();
  canvas.width = previewVideo.videoWidth || 640;
  canvas.height = previewVideo.videoHeight || 480;
}

// --- Captura frames reais (10s) ---
function captureFrames(duration=10000){
  frames = [];
  recording = true;
  const startTime = performance.now();

  function step(){
    if(!recording) return;
    const now = performance.now();
    if(now - startTime >= duration){
      recording = false;
      statusDiv.textContent = '‚è≥ Processando slow motion...';
      createSlowVideo();
      return;
    }
    ctx.drawImage(previewVideo,0,0,canvas.width,canvas.height);
    const frameData = ctx.getImageData(0,0,canvas.width,canvas.height);
    frames.push(frameData);
    requestAnimationFrame(step);
  }
  step();
}

// --- Cria v√≠deo slow motion duplicando frames ---
function createSlowVideo(slowFactor=2){
  const slowCanvas = document.createElement('canvas');
  slowCanvas.width = canvas.width;
  slowCanvas.height = canvas.height;
  const slowCtx = slowCanvas.getContext('2d');
  const slowStream = slowCanvas.captureStream(30);
  const mediaRecorder = new MediaRecorder(slowStream,{ mimeType:'video/webm;codecs=vp8' });
  let chunks = [];

  mediaRecorder.ondataavailable = e=>{ if(e.data && e.data.size) chunks.push(e.data); };
  mediaRecorder.start();

  let frameIndex = 0;
  let repeatCount = 0;

  function drawSlow(){
    if(frameIndex >= frames.length){
      mediaRecorder.stop();
      return;
    }

    slowCtx.putImageData(frames[frameIndex],0,0);

    repeatCount++;
    if(repeatCount >= slowFactor){
      repeatCount=0;
      frameIndex++;
    }

    requestAnimationFrame(drawSlow);
  }

  drawSlow();

  mediaRecorder.onstop = ()=>{
    const blob = new Blob(chunks,{type:'video/webm'});
    const url = URL.createObjectURL(blob);
    statusDiv.innerHTML = `‚úÖ Slow motion pronto!<br><a href="${url}" target="_blank">Abrir v√≠deo</a>`;
    // envia para index gerar QR code
    window.parent.postMessage({ videoBlob: blob }, '*');
  };
}

// --- Bot√£o ---
startBtn.onclick = async ()=>{
  startBtn.disabled = true;
  if(!stream) await initCamera();
  captureFrames(10000); // 10s reais
};
</script>
</body>
</html>
